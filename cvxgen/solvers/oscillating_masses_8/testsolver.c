#include <stdio.h>
#include <time.h>
#include "solver.h"
#define MIN(a,b) (((a)<(b))?(a):(b))

Vars vars;
Params params;
Workspace work;
Settings settings;
int main(int argc, char **argv) {
  set_defaults();
   setup_indexing();
   settings.verbose = 0;
   settings.resid_tol = 1e-7;
   settings.eps = 1e-7;
   double N = 1000;
   double solve_time_sec = 1e10;
   for (int i = 0; i < N; ++i) {
       struct timespec start, end;
       clock_gettime(CLOCK_MONOTONIC, &start);
       load_default_data();
       solve();
       clock_gettime(CLOCK_MONOTONIC, &end);
       double elapsed_time = (end.tv_sec - start.tv_sec) + (end.tv_nsec - start.tv_nsec) / 1e9;
       solve_time_sec = MIN(solve_time_sec, elapsed_time);
   }
   printf("\nSolvetime: %.9f ms", 1e3 * solve_time_sec);
   FILE *file = fopen("result.bin", "wb");
   fwrite(&work.converged, sizeof(unsigned char), 1, file);
   fwrite(&work.optval, sizeof(double), 1, file);
   fwrite(&solve_time_sec, sizeof(double), 1, file);
   fclose(file);
   printf("\nobj: %f", work.optval);
}void load_default_data() {
   params.x_0[0] = -1.085631;
   params.x_0[1] = 0.997345;
   params.x_0[2] = 0.282978;
   params.x_0[3] = -1.506295;
   params.x_0[4] = -0.578600;
   params.x_0[5] = 1.651437;
   params.x_0[6] = -1.900000;
   params.x_0[7] = -0.428913;
   params.Q[0] = 1.000000;
   params.Q[1] = 1.000000;
   params.Q[2] = 1.000000;
   params.Q[3] = 1.000000;
   params.Q[4] = 1.000000;
   params.Q[5] = 1.000000;
   params.Q[6] = 1.000000;
   params.Q[7] = 1.000000;
   params.R[0] = 5.000000;
   params.R[1] = 5.000000;
   params.R[2] = 5.000000;
   params.R[3] = 5.000000;
   params.A[0] = 0.938309;
   params.A[1] = 0.030604;
   params.A[2] = 0.000161;
   params.A[3] = 0.000000;
   params.A[4] = -0.487093;
   params.A[5] = 0.239697;
   params.A[6] = 0.002556;
   params.A[7] = 0.000008;
   params.A[8] = 0.030604;
   params.A[9] = 0.938470;
   params.A[10] = 0.030604;
   params.A[11] = 0.000161;
   params.A[12] = 0.239697;
   params.A[13] = -0.484537;
   params.A[14] = 0.239705;
   params.A[15] = 0.002556;
   params.A[16] = 0.000161;
   params.A[17] = 0.030604;
   params.A[18] = 0.938470;
   params.A[19] = 0.030604;
   params.A[20] = 0.002556;
   params.A[21] = 0.239705;
   params.A[22] = -0.484537;
   params.A[23] = 0.239697;
   params.A[24] = 0.000000;
   params.A[25] = 0.000161;
   params.A[26] = 0.030604;
   params.A[27] = 0.938309;
   params.A[28] = 0.000008;
   params.A[29] = 0.002556;
   params.A[30] = 0.239697;
   params.A[31] = -0.487093;
   params.A[32] = 0.244832;
   params.A[33] = 0.002572;
   params.A[34] = 0.000008;
   params.A[35] = 0.000000;
   params.A[36] = 0.938309;
   params.A[37] = 0.030604;
   params.A[38] = 0.000161;
   params.A[39] = 0.000000;
   params.A[40] = 0.002572;
   params.A[41] = 0.244840;
   params.A[42] = 0.002572;
   params.A[43] = 0.000008;
   params.A[44] = 0.030604;
   params.A[45] = 0.938470;
   params.A[46] = 0.030604;
   params.A[47] = 0.000161;
   params.A[48] = 0.000008;
   params.A[49] = 0.002572;
   params.A[50] = 0.244840;
   params.A[51] = 0.002572;
   params.A[52] = 0.000161;
   params.A[53] = 0.030604;
   params.A[54] = 0.938470;
   params.A[55] = 0.030604;
   params.A[56] = 0.000000;
   params.A[57] = 0.000008;
   params.A[58] = 0.002572;
   params.A[59] = 0.244832;
   params.A[60] = 0.000000;
   params.A[61] = 0.000161;
   params.A[62] = 0.030604;
   params.A[63] = 0.938309;
   params.B[0] = 0.030926;
   params.B[1] = 0.000161;
   params.B[2] = 0.000000;
   params.B[3] = 0.000000;
   params.B[4] = 0.244832;
   params.B[5] = 0.002572;
   params.B[6] = 0.000008;
   params.B[7] = 0.000000;
   params.B[8] = 0.000161;
   params.B[9] = 0.030927;
   params.B[10] = 0.000161;
   params.B[11] = 0.000000;
   params.B[12] = 0.002572;
   params.B[13] = 0.244840;
   params.B[14] = 0.002572;
   params.B[15] = 0.000008;
   params.B[16] = 0.000000;
   params.B[17] = 0.000161;
   params.B[18] = 0.030927;
   params.B[19] = 0.000161;
   params.B[20] = 0.000008;
   params.B[21] = 0.002572;
   params.B[22] = 0.244840;
   params.B[23] = 0.002572;
   params.B[24] = 0.000000;
   params.B[25] = 0.000000;
   params.B[26] = 0.000161;
   params.B[27] = 0.030926;
   params.B[28] = 0.000000;
   params.B[29] = 0.000008;
   params.B[30] = 0.002572;
   params.B[31] = 0.244832;
   params.u_max[0] = 5.000000;
   params.x_max[0] = 2.000000;
}
